-- Mise à jour n° de version
UPDATE `system` SET `value`='v5.5.0' WHERE `name`='base' and `groupe`='module';

-- Mode vitale
INSERT INTO `configuration` (`name`, `level`, `toID`, `module`, `cat`, `type`, `description`, `value`) VALUES ('vitaleMode', 'default', '0', '', 'Vitale', 'texte', 'simple / complet', 'simple');

-- Modification types pour autosize
UPDATE `data_types` SET `formType` = 'textarea' WHERE `name` = 'job';
UPDATE `data_types` SET `formType` = 'textarea' WHERE `name` = 'toxiques';

-- Modification formulaires pour autosize
UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'baseSynthese,rows=8', 'baseSynthese,rows=2') where internalName = 'baseSynthese';

UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'atcdMedicChir,rows=6', 'atcdMedicChir,rows=2') where internalName = 'baseATCD';
UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'atcdFamiliaux,rows=6', 'atcdFamiliaux,rows=2') where internalName = 'baseATCD';
UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, 'allergies,rows=2', 'allergies,rows=1') where internalName = 'baseATCD';
UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, '- job', '- job,rows=1') where internalName = 'baseATCD';
UPDATE `forms` SET `yamlStructure` = replace(yamlStructure, '- toxiques', '- toxiques,rows=1') where internalName = 'baseATCD';

update `forms` set `javascript`='$(document).ready(function() {\r\n\r\n  //calcul IMC\r\n  if ($(\'#id_imc_id\').length > 0) {\r\n\r\n    imc = imcCalc($(\'#id_poids_id\').val(), $(\'#id_taillePatient_id\').val());\r\n    if (imc > 0) {\r\n      $(\'#id_imc_id\').val(imc);\r\n    }\r\n\r\n    $(\"#patientLatCol\").on(\"keyup\", \"#id_poids_id , #id_taillePatient_id\", function() {\r\n      poids = $(\'#id_poids_id\').val();\r\n      taille = $(\'#id_taillePatient_id\').val();\r\n      imc = imcCalc(poids, taille);\r\n      $(\'#id_imc_id\').val(imc);\r\n      patientID = $(\'#identitePatient\').attr(\"data-patientID\");\r\n      setPeopleDataByTypeName(imc, patientID, \'imc\', \'#id_imc_id\', \'0\');\r\n\r\n    });\r\n  }\r\n\r\n  //ajutement auto des textarea en hauteur\r\n  autosize($(\'#formName_baseATCD textarea\')); \r\n  \r\n  ////////////////////////////////////////////////////////////////////////\r\n  ///////// Gestion Allergies\r\n\r\n  // ajout Allergies\r\n  $(\"#patientLatCol\").on(\"click\", \"button.getAllergiesPanel\", function(e) {\r\n    e.preventDefault();\r\n    $(\'#texteRechercheAllergie\').attr(\'data-parentid\', $(this).attr(\'data-parentid\'));\r\n  });\r\n  $(\'#searchAllergie\').on(\'shown.bs.modal\', function() {\r\n    $(\"#texteRechercheAllergie\").val(\'\');\r\n    $(\'#codeAllergietrouves\').html(\'\');\r\n    $(\"#texteRechercheAllergie\").focus();\r\n  })\r\n\r\n  // interogation sur mot clé\r\n  $(\"#texteRechercheAllergie\").typeWatch({\r\n    wait: 1000,\r\n    highlight: false,\r\n    allowSubmit: false,\r\n    captureLength: 3,\r\n    callback: function(value) {\r\n      $.ajax({\r\n        url: urlBase + \'/lap/ajax/allergieSearch/\',\r\n        type: \'post\',\r\n        data: {\r\n          term: value,\r\n          parentid: $(\'#texteRechercheAllergie\').attr(\'data-parentid\')\r\n        },\r\n        dataType: \"html\",\r\n        beforeSend: function() {\r\n          $(\'#codeAllergietrouves\').html(\'<div class=\"col-md-12\">Attente des résultats de la recherche ...</div>\');\r\n        },\r\n        success: function(data) {\r\n          $(\'#codeAllergietrouves\').html(data);\r\n        },\r\n        error: function() {\r\n          alert(\'Problème, rechargez la page !\');\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  // ajouter allergie\r\n  $(\"#searchAllergie\").on(\"click\", \"button.addAllergieToPatient\", function(e) {\r\n    origin = $(this);\r\n    label = $(this).attr(\'data-label\');\r\n    $.ajax({\r\n      url: urlBase + \'/lap/ajax/allergieAdd/\',\r\n      type: \'post\',\r\n      data: {\r\n        patientID: $(\'#identitePatient\').attr(\"data-patientID\"),\r\n        codeAller: $(this).attr(\'data-code\'),\r\n        libelleAller: label,\r\n        parentID: $(this).attr(\'data-parentid\')\r\n      },\r\n      dataType: \"json\",\r\n      success: function(data) {\r\n        if (data[\'statut\'] == \'ok\') {\r\n          origin.closest(\'tr\').addClass(\"success\");\r\n          origin.attr(\'disabled\', \'disabled\');\r\n          $(\"#atcdTableauAllergieStruc\").removeClass(\'d-none\');\r\n          $(\"#atcdTableauAllergieStruc tbody\").append(\'<tr class=\"tr{{ id }} table-warning small\"><td>\' + label + \'</td></tr>\');\r\n        } else {\r\n          alert(\'Problème, rechargez la page !\');\r\n        }\r\n      },\r\n      error: function() {\r\n        alert(\'Problème, rechargez la page !\');\r\n      }\r\n    });\r\n  });\r\n\r\n  // retirer allergie\r\n  $(\"#patientLatCol\").on(\"click\", \"button.removeAllergie\", function(e) {\r\n    e.preventDefault();\r\n    origin = $(this);\r\n    objetid = $(this).attr(\'data-objetid\');\r\n    $.ajax({\r\n      url: urlBase + \'/lap/ajax/allergieDel/\',\r\n      type: \'post\',\r\n      data: {\r\n        patientID: $(\'#identitePatient\').attr(\"data-patientID\"),\r\n        objetID: objetid\r\n      },\r\n      dataType: \"json\",\r\n      success: function(data) {\r\n        if (data[\'statut\'] == \'ok\') {\r\n          $(\"#atcdTableauAllergieStruc tr.tr\" + objetid).remove();\r\n        } else {\r\n          alert(\'Problème, rechargez la page !\');\r\n        }\r\n      },\r\n      error: function() {\r\n        alert(\'Problème, rechargez la page !\');\r\n      }\r\n    });\r\n  });\r\n\r\n});' where internalName = 'baseATCD';
update `forms` set `javascript`='$(document).ready(function() {  \r\n  //ajutement auto des textarea en hauteur\r\n  autosize($(\'#formName_baseSynthese textarea\'));\r\n });' where internalName = 'baseSynthese';
